name: Deploy Frontend to GCS + CDN

on:
  push:
    branches:
      - main  # Deploys to dev automatically
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  NODE_VERSION: '18'
  VITE_APP_VERSION: ${{ github.sha }}

jobs:
  # ============================================================================
  # Build Frontend
  # ============================================================================
  build:
    name: Build React App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build for production
        working-directory: frontend
        run: npm run build
        env:
          # Set API URL based on environment
          VITE_API_URL: ${{ github.event.inputs.environment == 'prod' && 'https://api.vividly.mnps.edu' || github.event.inputs.environment == 'staging' && 'https://api-staging.vividly.mnps.edu' || 'https://dev-vividly-api-2ufowb4fxa-uc.a.run.app' }}
          VITE_APP_ENV: ${{ github.event.inputs.environment || 'dev' }}

      - name: Analyze bundle size
        working-directory: frontend
        run: |
          echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Gzip Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|-----------|" >> $GITHUB_STEP_SUMMARY

          # Analyze JS bundles
          for file in dist/assets/*.js; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              gzip_size=$(gzip -c "$file" | wc -c | numfmt --to=iec-i --suffix=B)
              echo "| $filename | $size | $gzip_size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Check bundle size budgets
          total_js_size=$(find dist/assets -name "*.js" -exec du -b {} \; | awk '{sum+=$1} END {print sum}')
          total_js_mb=$(echo "scale=2; $total_js_size/1048576" | bc)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total JS Size:** ${total_js_mb}MB" >> $GITHUB_STEP_SUMMARY

          # Warn if bundle exceeds 2MB (reasonable for a SPA)
          if (( $(echo "$total_js_mb > 2.0" | bc -l) )); then
            echo "âš ï¸ **Warning:** Total JS bundle size exceeds 2MB performance budget" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Bundle size within performance budget" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # ============================================================================
  # Deploy to Dev (automatic on main push)
  # ============================================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
      url: https://storage.googleapis.com/vividly-dev-rich-frontend-dev/index.html

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-dev-rich-frontend-dev/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-dev-rich-frontend-dev/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-dev-rich-frontend-dev/index.html'

      - name: Invalidate CDN cache (if using Cloud CDN)
        run: |
          echo "CDN cache invalidation would go here"
          # gcloud compute url-maps invalidate-cdn-cache dev-vividly-frontend-urlmap \
          #   --path "/*" \
          #   --async
        continue-on-error: true

      - name: Health check deployment
        run: |
          echo "ðŸ¥ Running health checks..."

          # Wait for deployment to propagate
          sleep 5

          # Check if index.html is accessible
          HTTP_CODE=$(curl -sL -w "%{http_code}" -o /dev/null "https://storage.googleapis.com/vividly-dev-rich-frontend-dev/index.html")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Health check passed - Site is accessible (HTTP $HTTP_CODE)"

            # Check if critical assets exist
            echo "Checking critical assets..."

            # Verify at least one JS bundle exists
            if gsutil ls gs://vividly-dev-rich-frontend-dev/assets/*.js | head -1 > /dev/null 2>&1; then
              echo "âœ… JavaScript bundles found"
            else
              echo "âš ï¸ Warning: No JavaScript bundles found"
              exit 1
            fi

            # Verify CSS exists
            if gsutil ls gs://vividly-dev-rich-frontend-dev/assets/*.css | head -1 > /dev/null 2>&1; then
              echo "âœ… CSS stylesheets found"
            else
              echo "âš ï¸ Warning: No CSS stylesheets found"
            fi

            echo "## ðŸŽ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** Dev" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** https://storage.googleapis.com/vividly-dev-rich-frontend-dev/index.html" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… All health checks passed" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health check failed - HTTP $HTTP_CODE"
            echo "## âŒ Deployment Health Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "HTTP Status: $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Deploy to Staging (manual trigger only)
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.vividly.mnps.edu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-staging-frontend-staging/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-staging-frontend-staging/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-staging-frontend-staging/index.html'

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache staging-vividly-frontend-urlmap \
            --path "/*" \
            --async || echo "CDN cache invalidation failed (may not be configured yet)"
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "âœ… Frontend deployed to Staging environment"
          echo "ðŸ”— URL: https://staging.vividly.mnps.edu"

  # ============================================================================
  # Deploy to Production (manual trigger only, requires approval)
  # ============================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment:
      name: prod
      url: https://vividly.mnps.edu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create backup of current deployment
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          gsutil -m rsync -r \
            gs://vividly-prod-frontend-prod/ \
            gs://vividly-prod-frontend-prod-backups/$TIMESTAMP/ || echo "No existing deployment to backup"
        continue-on-error: true

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-prod-frontend-prod/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-prod-frontend-prod/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-prod-frontend-prod/index.html'

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache prod-vividly-frontend-urlmap \
            --path "/*" \
            --async

      - name: Verify deployment
        run: |
          # Wait for CDN cache invalidation to start
          sleep 10

          # Check if index.html is accessible
          curl -sI https://vividly.mnps.edu | grep "200 OK" || echo "âš ï¸ Deployment verification warning"

      - name: Deployment summary
        run: |
          echo "âœ… Frontend deployed to Production environment"
          echo "ðŸ”— URL: https://vividly.mnps.edu"
          echo "ðŸ“¦ Backup created with timestamp"

      - name: Notify deployment
        if: always()
        run: |
          echo "ðŸ”” Production deployment notification would be sent here"
          # Add Slack/email notification here

  # ============================================================================
  # Preview Deployment (for Pull Requests)
  # ============================================================================
  preview-deploy:
    name: Preview Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: https://storage.googleapis.com/vividly-dev-rich-frontend-dev/pr-${{ github.event.pull_request.number }}/index.html

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy preview to GCS
        working-directory: frontend/dist
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_PATH="pr-${PR_NUMBER}"

          echo "ðŸ“¦ Deploying preview for PR #${PR_NUMBER}..."

          # Sync files to PR-specific path
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-dev-rich-frontend-dev/${PR_PATH}/

          # Set cache control
          gsutil -m setmeta -h "Cache-Control:public, max-age=300" \
            "gs://vividly-dev-rich-frontend-dev/${PR_PATH}/**"

          echo "## ðŸŽ¬ Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Request:** #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** https://storage.googleapis.com/vividly-dev-rich-frontend-dev/${PR_PATH}/index.html" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Preview deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ This preview will be automatically cleaned up after the PR is merged or closed." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://storage.googleapis.com/vividly-dev-rich-frontend-dev/pr-${prNumber}/index.html`;

            const comment = `## ðŸŽ¬ Preview Deployment Ready!

            Your changes have been deployed to a preview environment:

            ðŸ”— **Preview URL:** ${previewUrl}

            This preview will be updated automatically when you push new commits to this PR.

            ---
            <sub>Built from commit ${context.sha.substring(0, 7)}</sub>`;

            // Find existing preview comment
            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployment Ready')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }

  # ============================================================================
  # Security Scan (runs on PRs)
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run npm audit
        working-directory: frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./frontend
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

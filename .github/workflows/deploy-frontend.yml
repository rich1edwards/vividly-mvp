name: Deploy Frontend to GCS + CDN

on:
  push:
    branches:
      - main  # Deploys to dev automatically
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  NODE_VERSION: '18'
  VITE_APP_VERSION: ${{ github.sha }}

jobs:
  # ============================================================================
  # Build Frontend
  # ============================================================================
  build:
    name: Build React App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run linting
        working-directory: frontend
        run: npm run lint
        continue-on-error: true

      - name: Run tests
        working-directory: frontend
        run: npm test -- --ci --coverage --maxWorkers=2
        env:
          CI: true

      - name: Build for production
        working-directory: frontend
        run: npm run build
        env:
          # Set API URL based on environment
          VITE_API_URL: ${{ github.event.inputs.environment == 'prod' && 'https://api.vividly.mnps.edu' || github.event.inputs.environment == 'staging' && 'https://api-staging.vividly.mnps.edu' || 'https://dev-vividly-api-2ufowb4fxa-uc.a.run.app' }}
          VITE_APP_ENV: ${{ github.event.inputs.environment || 'dev' }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # ============================================================================
  # Deploy to Dev (automatic on main push)
  # ============================================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
      url: https://storage.googleapis.com/vividly-dev-rich-frontend-dev/index.html

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-dev-rich-frontend-dev/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-dev-rich-frontend-dev/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-dev-rich-frontend-dev/index.html'

      - name: Invalidate CDN cache (if using Cloud CDN)
        run: |
          echo "CDN cache invalidation would go here"
          # gcloud compute url-maps invalidate-cdn-cache dev-vividly-frontend-urlmap \
          #   --path "/*" \
          #   --async
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "‚úÖ Frontend deployed to Dev environment"
          echo "üîó URL: https://storage.googleapis.com/vividly-dev-rich-frontend-dev/index.html"

  # ============================================================================
  # Deploy to Staging (manual trigger only)
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.vividly.mnps.edu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-staging-frontend-staging/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-staging-frontend-staging/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-staging-frontend-staging/index.html'

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache staging-vividly-frontend-urlmap \
            --path "/*" \
            --async || echo "CDN cache invalidation failed (may not be configured yet)"
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "‚úÖ Frontend deployed to Staging environment"
          echo "üîó URL: https://staging.vividly.mnps.edu"

  # ============================================================================
  # Deploy to Production (manual trigger only, requires approval)
  # ============================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment:
      name: prod
      url: https://vividly.mnps.edu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create backup of current deployment
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          gsutil -m rsync -r \
            gs://vividly-prod-frontend-prod/ \
            gs://vividly-prod-frontend-prod-backups/$TIMESTAMP/ || echo "No existing deployment to backup"
        continue-on-error: true

      - name: Deploy to GCS
        working-directory: frontend/dist
        run: |
          # Sync files to GCS bucket
          gsutil -m rsync -r -d \
            -x '.*\.map$' \
            . gs://vividly-prod-frontend-prod/

          # Set cache control for different file types
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            'gs://vividly-prod-frontend-prod/assets/**'

          gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" \
            'gs://vividly-prod-frontend-prod/index.html'

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache prod-vividly-frontend-urlmap \
            --path "/*" \
            --async

      - name: Verify deployment
        run: |
          # Wait for CDN cache invalidation to start
          sleep 10

          # Check if index.html is accessible
          curl -sI https://vividly.mnps.edu | grep "200 OK" || echo "‚ö†Ô∏è Deployment verification warning"

      - name: Deployment summary
        run: |
          echo "‚úÖ Frontend deployed to Production environment"
          echo "üîó URL: https://vividly.mnps.edu"
          echo "üì¶ Backup created with timestamp"

      - name: Notify deployment
        if: always()
        run: |
          echo "üîî Production deployment notification would be sent here"
          # Add Slack/email notification here

  # ============================================================================
  # Security Scan (runs on PRs)
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run npm audit
        working-directory: frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./frontend
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

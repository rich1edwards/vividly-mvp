name: Rate Limiting & Security Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/app/middleware/security.py'
      - 'backend/app/core/rate_limit.py'
      - 'backend/tests/test_rate_limiting.py'
      - 'backend/requirements*.txt'
      - '.github/workflows/rate-limit-tests.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/app/middleware/security.py'
      - 'backend/app/core/rate_limit.py'
      - 'backend/tests/test_rate_limiting.py'
      - 'backend/requirements*.txt'
      - '.github/workflows/rate-limit-tests.yml'
  workflow_dispatch:  # Allow manual trigger
  schedule:
    # Run daily at 2 AM UTC to catch any regressions
    - cron: '0 2 * * *'

jobs:
  rate-limit-tests:
    name: Rate Limiting Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    env:
      # Test environment variables
      DATABASE_URL: "sqlite:///:memory:"
      SECRET_KEY: "test_secret_key_12345_github_actions_rate_limit"
      ALGORITHM: "HS256"
      DEBUG: "True"
      CORS_ORIGINS: "http://localhost"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-timeout

      - name: Run rate limiting configuration tests
        working-directory: backend
        run: |
          PYTHONPATH=$PWD python -m pytest tests/test_rate_limiting.py::TestRateLimitConfiguration \
            -v \
            --cov=app/core/rate_limit \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results-rate-limit-config.xml

      - name: Run security headers tests
        working-directory: backend
        run: |
          PYTHONPATH=$PWD python -m pytest tests/test_rate_limiting.py::TestSecurityHeaders \
            -v \
            --cov=app/middleware/security \
            --cov-append \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results-security-headers.xml

      - name: Run rate limit middleware tests
        working-directory: backend
        continue-on-error: true  # These may require live server
        run: |
          PYTHONPATH=$PWD python -m pytest tests/test_rate_limiting.py::TestRateLimitMiddleware \
            -v \
            --cov=app/middleware/security \
            --cov-append \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results-rate-limit-middleware.xml \
            --timeout=30

      - name: Run brute force protection tests
        working-directory: backend
        continue-on-error: true  # These may require live server
        run: |
          PYTHONPATH=$PWD python -m pytest tests/test_rate_limiting.py::TestBruteForceProtection \
            -v \
            --cov=app/middleware/security \
            --cov-append \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results-brute-force.xml \
            --timeout=30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-rate-limit-${{ matrix.python-version }}
          path: |
            backend/test-results-*.xml
          retention-days: 30

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-rate-limit-${{ matrix.python-version }}
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 30

      - name: Comment test results on PR
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: github.event_name == 'pull_request'
        with:
          check_name: Rate Limiting Tests (Python ${{ matrix.python-version }})
          files: backend/test-results-*.xml

      - name: Check coverage threshold
        working-directory: backend
        run: |
          # Calculate coverage for rate limiting code
          COVERAGE=$(python -m pytest tests/test_rate_limiting.py::TestRateLimitConfiguration \
            --cov=app/core/rate_limit \
            --cov=app/middleware/security \
            --cov-report=term | grep "TOTAL" | awk '{print $4}' | sed 's/%//' || echo "0")

          echo "Rate Limiting Coverage: ${COVERAGE}%"

          # Threshold: 70% for now (will increase as tests mature)
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below 70% threshold"
            # Don't fail the build yet, just warn
          else
            echo "::notice::Coverage ${COVERAGE}% meets or exceeds 70% threshold"
          fi

  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety semgrep

      - name: Run Bandit security scan
        working-directory: backend
        continue-on-error: true
        run: |
          bandit -r app/middleware/security.py \
                    app/core/rate_limit.py \
                 -f json -o bandit-rate-limit.json || true
          bandit -r app/middleware/security.py \
                    app/core/rate_limit.py \
                 -f txt || true

      - name: Run Semgrep security scan
        working-directory: backend
        continue-on-error: true
        run: |
          semgrep --config=auto \
                   --json \
                   --output=semgrep-rate-limit.json \
                   app/middleware/security.py \
                   app/core/rate_limit.py || true

      - name: Check for common vulnerabilities
        working-directory: backend
        run: |
          echo "Checking for common security issues in rate limiting code..."

          # Check for hardcoded secrets
          if grep -rn "password\|secret\|key" app/core/rate_limit.py app/middleware/security.py | grep -v "SECRET_KEY" | grep -v "def\|class\|import\|#"; then
            echo "::warning::Potential hardcoded secrets found"
          fi

          # Check for SQL injection risks
          if grep -rn "execute\|query" app/middleware/security.py | grep -v "def\|class\|import\|#"; then
            echo "::notice::SQL operations found - verify parameterization"
          fi

          # Check for proper error handling
          if ! grep -q "try:" app/middleware/security.py; then
            echo "::warning::Limited error handling in security middleware"
          fi

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-rate-limit
          path: |
            backend/bandit-rate-limit.json
            backend/semgrep-rate-limit.json
          retention-days: 30

  load-testing:
    name: Rate Limit Load Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install locust

      - name: Create load test script
        working-directory: backend
        run: |
          cat > locustfile.py << 'EOF'
          from locust import HttpUser, task, between
          import time

          class RateLimitUser(HttpUser):
              wait_time = between(0.1, 0.5)

              @task(3)
              def test_rate_limit_compliance(self):
                  """Test that we stay within rate limits"""
                  # Simulate normal usage - should not hit rate limits
                  response = self.client.get("/health")

              @task(1)
              def test_rate_limit_boundary(self):
                  """Test rate limit boundaries"""
                  # Make rapid requests to test limits
                  for i in range(5):
                      response = self.client.post("/api/v1/auth/login", json={
                          "email": f"test{i}@example.com",
                          "password": "test123"
                      })
                      if response.status_code == 429:
                          print(f"Rate limit triggered after {i} requests")
                          break
                      time.sleep(0.1)
          EOF

      - name: Run load test (headless)
        working-directory: backend
        continue-on-error: true
        run: |
          echo "Note: This is a simulated load test. Real load testing requires a running server."
          echo "Load test script created for future use."

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [rate-limit-tests, security-analysis]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Rate Limiting & Security Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Tests completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Rate limiting configuration tests: See artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security headers tests: See artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security analysis: See artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review test results in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "3. Address any security warnings" >> $GITHUB_STEP_SUMMARY
          echo "4. Run load tests in staging environment" >> $GITHUB_STEP_SUMMARY

# Sprint 3 Phase 4: Monitoring Dashboard Deployment via Cloud Build
# Following Andrew Ng's "Test everything" principle
# Verifies and deploys GCP monitoring dashboards

substitutions:
  _PROJECT_ID: vividly-dev-rich
  _ENVIRONMENT: dev

steps:
  # Step 1: Verify dashboard configuration before deployment
  - name: 'python:3.11-slim'
    id: 'verify-dashboard-config'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "========================================"
        echo "DASHBOARD CONFIGURATION VERIFICATION"
        echo "Sprint 3 Phase 4: Pre-deployment check"
        echo "========================================"

        # Install dependencies (no external packages needed for verification)
        # The script only uses stdlib: json, sys, pathlib

        # Run dashboard verification script
        python3 backend/scripts/verify_dashboards.py

        # Exit code 0 = pass, 1 = fail (blocks deployment)
    waitFor: ['-']  # Run first, before any other step

  # Step 2: Validate Terraform configuration
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-validate'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "========================================"
        echo "TERRAFORM CONFIGURATION VALIDATION"
        echo "Sprint 3 Phase 4: Infrastructure check"
        echo "========================================"

        cd infrastructure/monitoring/terraform

        # Initialize Terraform
        terraform init -backend=false

        # Validate configuration
        terraform validate

        echo ""
        echo "✓ Terraform configuration is valid"
    waitFor: ['verify-dashboard-config']

  # Step 3: Terraform plan (dry-run)
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-plan'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "========================================"
        echo "TERRAFORM PLAN (DRY-RUN)"
        echo "Sprint 3 Phase 4: Preview changes"
        echo "========================================"

        cd infrastructure/monitoring/terraform

        # Run terraform plan
        terraform plan \
          -var="project_id=${_PROJECT_ID}" \
          -var="environment=${_ENVIRONMENT}" \
          -out=tfplan

        echo ""
        echo "✓ Terraform plan completed successfully"
    waitFor: ['terraform-validate']

  # Step 4: Deploy dashboard (manual approval required for prod)
  - name: 'hashicorp/terraform:1.6'
    id: 'terraform-apply'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "========================================"
        echo "DEPLOYING MONITORING DASHBOARD"
        echo "Sprint 3 Phase 4: Dashboard deployment"
        echo "========================================"

        cd infrastructure/monitoring/terraform

        # Apply terraform plan
        terraform apply -auto-approve tfplan

        echo ""
        echo "✓ Dashboard deployed successfully"
        echo ""
        echo "View dashboard in GCP Console:"
        echo "https://console.cloud.google.com/monitoring/dashboards?project=${_PROJECT_ID}"
    waitFor: ['terraform-plan']

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '600s'
